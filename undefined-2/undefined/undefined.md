# 메모리 사용량

## 서버의 '메모리 사용량'의 의미

단순히 서버가 얼마만큼의 메모리를 사용하냐라고 표현하는것 보다 자세하게 구체적으로 정리해보자. 편하게 '서버'라고 부르지만 정확하게는 '프로세스'이다. 스프링부트로 만든 서버는 자바로 만든 '프로세스'이다.

따라서 서버가 사용하는 메모리의 양은 해당 '프로세스'가 인스턴스에서 차지하는 '램'의 공간이다. 정리하자면 '메모리 사용량'이란 해당 프로세스가 얼마만큼의 램을 차지하는가 이다.



## Xmx, Xms 각각의 의미

### Xmx

최대 힙 메모리 설정(Maximum Heap Memory) 을 의미한다. Java 프로세스가 사용할 수 있는 힙 영역의 최대 크기를 의미한다. JVM은 이 크기를 초과해서 힙 메모리를 할당하지 않는다. 이 크기를 초과하게 되면 OutOfMemoryError 가 발생하며 프로세스가 중단될 수 있다.

### Xms

초기 힙 메모리 설정(Initial Heap Memory) 이다. '최소'가 아니다. '초기'다. Java 프로세스가 시작될 때 바로 할당되는 힙 영역의 크기를 지정한다.&#x20;



## Xms 는 작아도 되는거 아닌가?

어차피 최대까지 늘어나도 되기 때문에 Xms 가 작아도 아무 상관이 없는 것 같지만 그렇지 않다. Xms 는 초기에 할당되는 힙 메모리 영역인데 이것이 너무 작아서 더 큰 공간이 필요한 경우 JVM 은 바로 Xmx 로 주어진 크기까지 메모리 영역을 늘리지 않고 먼저 GC 를 동작 시켜서 메모리를 정리한다.

Xms 가 너무 작게 설정될 경우 불필요하게 계속 GC 가 동작하기 때문에 성능저하가 발생하는 것이다. 따라서 Xms 역시 프로세스의 규모에 맞게 여유있게 설정해야 한다.



## Xms 를 그럼 무조건 크게 설정해야하나?

크게 설정해도 문제인 것이 다시 강조하지만 '최소' 가 아니고 '초기' 영역이므로 설정해준 영역을 해당 프로세스가 모두 차지하게 된다.

예를 들어 2기가 램을 가진 인스턴스에서 Xms를 1.5기가로 설정해주면 해당 프로세스가 평균적으로 1기가만 쓰는 프로세스라 할지라도 영구적으로 1.5기가를 차지하게 되어서 나머지 프로세스들은 0.5만 가지고 나눠 먹어야하는 사태가 발생한다.

그래서 모니터링을 통해서 적절한 값을 설정해주는 것이 가장 좋다. Xmx, Xms 최적화가 중요하다는 이야기이다.



## Xmx, Xms 의 초기값

> 기본적으로 JVM의 Xmx와 Xms 옵션의 초기값은 서로 같습니다. 이 값은 JVM 버전과 사용하는 시스템에 따라 다를 수 있지만, 대부분의 경우 물리적인 메모리 크기에 따라 자동으로 설정됩니다. 일반적으로 초기값은 물리적인 메모리 크기의 일부로 설정되며, 일반적으로 1/64 정도로 설정될 수 있습니다.
>
> 예를 들어, 물리적인 메모리가 8GB인 시스템의 경우, 초기값과 최대값은 약 128MB 정도로 설정될 수 있습니다. 이러한 초기값은 대부분의 애플리케이션에서는 적절한 시작점을 제공하며, 필요에 따라 성능 조정을 위해 수정될 수 있습니다.
>
> 이 초기값은 특정 환경에서 애플리케이션이 시작될 때 자동으로 결정되기 때문에 개발자가 별도로 설정하지 않아도 됩니다. 하지만 필요에 따라 명시적으로 설정하여 최적화할 수 있습니다.



## Xmx, Xms 최적화는 어떤 기준으로 해야할까?

평소 모니터링을 통해서 해당 프로세스가 아무리 못해도 최소 어느정도의 메모리가 필요한지를 파악하고 이에 맞게 Xms를 설정해주는 것이 좋다.

그리고 모니터링을 통해서 트래픽이 몰리는 시간 등을 파악해서 해당 프로세스가 최대 어느정도의 메모리가 필요한지 최대 요구치를 파악해서 이것보다 여유있게 Xmx 를 설정해주는 것이 좋다. 인스턴스의 램이 여유가 많은데 Xmx 가 너무 박하게 설정되어 있는지도 확인해야한다.

그리고 이 모든 것들은 결국 트래픽에 따라 계속 변할 것이므로 영구적인 최적화는 없고 계속해서 모니터링을 해줘야한다.



## 메모리 사용량을 고려한 서버 모니터링

메모리 사용량이 일정치 이상을 넘어서면 알람을 주도록 처리하면 빠르게 대처할 수 있다. 또한 자동으로 스케일아웃이 되도록 설정하는 방법도 유용하다.

메모리 사용량에 따라 스케일 아웃이 되도록 설정이 되어있지 않은 상황에서 평소 트래픽을 관찰하지 않고, 메모리 사용량을 관찰하지 않는다면 프로세스는 언제든 예기치 않게 종료될 수 있다.

