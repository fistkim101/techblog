# CH03 영속성 관리

## 엔티티 매니저 팩토리와 엔티티 매니저

2장에서 살펴본 바와 같이 EntityManagerFactoryBuilder와 EntityManagerFactory는 bean 으로 관리된다. 나는 EntityManagerFactory 가 bean 으로 관리된다는 것만 인지하면 된다.

2장에서 이미 살펴보았기도 했고, 아래 그림에도 나와 있듯이 EntityManagerFactory 는 스레드마다 별도로 EntityManager 를 할당해준다. 이것의 의미는 곧 정리하겠지만 EntityManager 가 관리할 영속성 컨텍스트가 각 요청별로 따로 관리된다는 것이다.

<figure><img src="../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

## 영속성 컨텍스트(Persistence Context)

책에서는 '엔티티를 영구 저장하는 환경' 이라고 정의하고 있다. 영속성 컨텍스트는 엔티티 매니저를 생성할 때 만들어 지고 엔티티 매니저를 통해서 영속성 컨텍스트를 관리할 수 있다. 개인적으로 ‘영속성 관리를 목적으로 사용하는 공간’이라고 이해하는 것이 좋을 것 같다.

나의 경험 내에서는 결국 실무에서는 스프링 데이터 JPA 를 쓰기 때문에 EntityManager 를 직접 다룰 일은 없다. 하지만 영속성 컨텍스트가 무엇이며, 내부적으로 어떻게 동작하는지 원리를 알아두어야 스프링 데이터 JPA 가 결국에는 어떤 일을 하는지, 내부적으로 지금 어떤 일이 일어나고 있는지 정확하게 이해할 수 있다.

책에는 지금 순서에 영속성 컨텍스트에 대해서 개념만 짚고 넘어가고 있는데, 영속성 컨텍스트는 아래와 같은 형태이다. 이를 기억하자.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>



## 엔티티의 생명주기

* 비영속(new/transient): 영속성 컨텍스트와 전혀 관계가 없는 상태
* 영속(managed): 영속성 컨텍스트에 저장된 상태
* 준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태
* 삭제(removed): 삭제된 상태

각 상태 별로 자세히 알아보자.

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

### 비영속

엔티티를 만들고 어떤한 행위도 하지 않은 상태이다. 영속성 컨텍스트 및 데이터 베이스와 아무런 상관이 없는 객체 그대로의 상태다.

```java
Member member = new Member();
member.setName("홍길동");
```

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### 영속

```java
Member member = new Member();
member.setName("홍길동"); // 여기까지 아직 비영속 상태

entityManager.persist(member); // 이 순간 영속 상태가 된다
```

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>



### 준영속

위에서 알아본 바로 entityManager 가 객체를 관리하고 있는 중의 상태가 영속이고, 아예 영속된 적이 없는 순수한 엔티티 객체 상태가 비영속이었다. 준영속은 영속이었던 객체가 영속 상태에서 벗어난 것을 의미한다.

entityManager를 살려둔 채로 초기화를 시키거나, entityManager를 아예 닫아버리면 영속 상태이던 엔티티들은 모두 준영속 상태가 된다.

또는 entityManager에서 해당 엔티티만 준영속 상태로 처리할 수도 있다.

```java
// 1. entityManager 초기화
entityManager.clear();

// 2. entityManager 종료
entityManager.close();

// 3.해당 엔티티만 준영속 상태로 만든다.
entityManager.detach(member);
```



### 삭제

정확히는 삭제가 될 예정인 상태다. 준영속은 해당 엔티티에 대해서 entityManager 를 통해서 영속성 컨텍스트 내에서 더 이상 관리를 하지 않겠다는 의미이고, 삭제는 데이터베이스에서 지우겠다는 의미이다.

```java
entityManager.remove(member);
```





































